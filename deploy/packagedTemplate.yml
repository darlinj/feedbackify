Description: AWS AppSync Questionnaires API
Parameters:
  APIName:
    Type: String
    Description: Name of the API - used to generate unique names for resources
    MinLength: 3
    MaxLength: 20
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9_]*$
Resources:
  CognitoPool:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/pipeline-artifacts-bannana/packagedCloudformationAssetsDEV//f6277d1271f273a6a2d7a14c79e31733.template
      Parameters:
        NamePrefix:
          Ref: APIName
  DynamoDbTable:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/pipeline-artifacts-bannana/packagedCloudformationAssetsDEV//55a0c976a1a990eb89c60d22ca4e84d2.template
      Parameters:
        NamePrefix:
          Ref: APIName
  AppsyncAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.eu-west-1.amazonaws.com/pipeline-artifacts-bannana/packagedCloudformationAssetsDEV//14ac939585b05a9142abb593f898e08c.template
      Parameters:
        NamePrefix:
          Ref: APIName
        UserPoolId:
          Fn::GetAtt:
          - CognitoPool
          - Outputs.UserPoolId
        QuestionnaireTableName:
          Fn::GetAtt:
          - DynamoDbTable
          - Outputs.QuestionnaireTableID
        QuestionTableName:
          Fn::GetAtt:
          - DynamoDbTable
          - Outputs.QuestionTableID
        FeedbackTableName:
          Fn::GetAtt:
          - DynamoDbTable
          - Outputs.FeedbackTableID
        ServiceRoleArn:
          Fn::GetAtt:
          - DynamoDbTable
          - Outputs.DBRoleARN
Outputs:
  CognitoUserPoolId:
    Description: The pool id of the cognito user pool
    Value:
      Fn::GetAtt:
      - CognitoPool
      - Outputs.UserPoolId
  CognitoUserPoolClientId:
    Description: The Client ID for AWS AppSync Auth
    Value:
      Fn::GetAtt:
      - CognitoPool
      - Outputs.UserPoolClientId
  QuestionnairesTable:
    Description: The name of the DynamoDB Table
    Value:
      Fn::GetAtt:
      - DynamoDbTable
      - Outputs.QuestionnaireTableID
  GraphQLApiEndpoint:
    Description: The URL to the GraphQL Endpoint
    Value:
      Fn::GetAtt:
      - AppsyncAPI
      - Outputs.GraphQLApiEndpoint
  GraphQLApiId:
    Description: The API ID of the GraphQL API
    Value:
      Fn::GetAtt:
      - AppsyncAPI
      - Outputs.GraphQLApiId
