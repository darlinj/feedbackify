---
Description: AWS AppSync Questionnaires API

Parameters:
  SiteURL:
    Type: String
    Description: URL of the website
    Default: "http://something.com"

  APIName:
    Type: String
    Description: Name of the API - used to generate unique names for resources
    MinLength: 3
    AllowedPattern: "^[a-z][a-z0-9_-]*$"

Resources:
  CognitoPool:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: "./cognito.yml"
      Parameters:
        SiteURL:
          Ref: SiteURL
        NamePrefix:
          Ref: APIName
  DynamoDbTable:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: "./dynamoDB.yml"
      Parameters:
        NamePrefix:
          Ref: APIName
  AppsyncAPI:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: "./appsyncAPI.yml"
      Parameters:
        NamePrefix:
          Ref: APIName
        UserPoolId:
          Fn::GetAtt:
            - CognitoPool
            - Outputs.UserPoolId
        QuestionnaireTableName:
          Fn::GetAtt:
            - DynamoDbTable
            - Outputs.QuestionnaireTableID
        QuestionTableName:
          Fn::GetAtt:
            - DynamoDbTable
            - Outputs.QuestionTableID
        FeedbackTableName:
          Fn::GetAtt:
            - DynamoDbTable
            - Outputs.FeedbackTableID
        ServiceRoleArn:
          Fn::GetAtt:
            - DynamoDbTable
            - Outputs.DBRoleARN
  Website:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: "./Website.yml"
      Parameters:
        NamePrefix:
          Ref: APIName
        SiteURL:
          Ref: SiteURL
        UserPoolId:
          Fn::GetAtt:
            - CognitoPool
            - Outputs.UserPoolId
        UserPoolClientId:
          Fn::GetAtt:
            - CognitoPool
            - Outputs.UserPoolClientId
        GraphQLApiEndpoint:
          Fn::GetAtt:
            - AppsyncAPI
            - Outputs.GraphQLApiEndpoint
        ApiKey:
          Fn::GetAtt:
            - AppsyncAPI
            - Outputs.ApiKey

Outputs:
  CognitoUserPoolId:
    Description: The pool id of the cognito user pool
    Value:
      Fn::GetAtt:
        - CognitoPool
        - Outputs.UserPoolId
  CognitoUserPoolClientId:
    Description: The Client ID for AWS AppSync Auth
    Value:
      Fn::GetAtt:
        - CognitoPool
        - Outputs.UserPoolClientId
  QuestionnairesTable:
    Description: The name of the DynamoDB Table
    Value:
      Fn::GetAtt:
        - DynamoDbTable
        - Outputs.QuestionnaireTableID
  GraphQLApiEndpoint:
    Description: The URL to the GraphQL Endpoint
    Value:
      Fn::GetAtt:
        - AppsyncAPI
        - Outputs.GraphQLApiEndpoint
  GraphQLApiKey:
    Description: The API key to the public GraphQL Endpoint
    Value:
      Fn::GetAtt:
        - AppsyncAPI
        - Outputs.ApiKey
  GraphQLApiId:
    Description: The API ID of the GraphQL API
    Value:
      Fn::GetAtt:
        - AppsyncAPI
        - Outputs.GraphQLApiId
